import { createClient } from "@supabase/supabase-js"
import * as XLSX from "xlsx"

// Valores padr√£o para desenvolvimento (substitua pelos seus valores reais em produ√ß√£o)
const defaultUrl = "https://jtzbuxoslaotpnwsphqv.supabase.co"
const defaultAnonKey =
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imp0emJ1eG9zbGFvdHBud3NwaHF2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDI1MDU5MDEsImV4cCI6MjA1ODA4MTkwMX0.jmI-h8pKW00TN5uNpo3Q16GaZzOpFAnPUVO0yyNq54U"

// Usar valores do ambiente se dispon√≠veis, caso contr√°rio usar os padr√µes
const supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL || defaultUrl
const supabaseAnonKey = process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY || defaultAnonKey

// Criar cliente Supabase
export const supabase = createClient(supabaseUrl, supabaseAnonKey, {
  auth: {
    persistSession: true,
    autoRefreshToken: true,
    detectSessionInUrl: true,
  },
})

// Exportar tamb√©m como default
export default supabase

// Fun√ß√£o para testar conex√£o (nome original mantido para compatibilidade)
export async function testarConexaoSupabase() {
  try {
    console.log("üîç Testando conex√£o com Supabase...")
    console.log("URL:", supabaseUrl)
    console.log("Key (primeiros 10 caracteres):", supabaseAnonKey.substring(0, 10) + "...")

    // Teste simples de conex√£o
    const { data, error } = await supabase.from("propostas").select("id").limit(1)

    if (error) {
      console.error("‚ùå Erro ao testar conex√£o Supabase:", error)
      return false
    }

    console.log("‚úÖ Conex√£o Supabase funcionando! Dados recebidos:", data)
    return true
  } catch (error) {
    console.error("‚ùå Erro inesperado ao testar Supabase:", error)
    return false
  }
}

// Fun√ß√£o alternativa para testar conex√£o
export async function testarConexao() {
  try {
    const { data, error } = await supabase.from("produtos_corretores").select("id").limit(1)

    if (error) {
      console.error("‚ùå Erro ao testar conex√£o:", error)
      return { success: false, error: error.message }
    }

    console.log("‚úÖ Conex√£o Supabase OK")
    return { success: true, data }
  } catch (error) {
    console.error("‚ùå Erro inesperado:", error)
    return { success: false, error: error.message }
  }
}

// Fun√ß√£o para verificar explicitamente as chaves de API
export async function verificarChavesAPI() {
  try {
    console.log("üîç Verificando chaves de API...")

    // Verificar se as chaves est√£o definidas
    if (!supabaseUrl || supabaseUrl.trim() === "") {
      console.error("‚ùå URL do Supabase n√£o definida")
      return {
        success: false,
        message: "URL do Supabase n√£o definida",
        details: { url: false, key: false },
      }
    }

    if (!supabaseAnonKey || supabaseAnonKey.trim() === "") {
      console.error("‚ùå Chave an√¥nima do Supabase n√£o definida")
      return {
        success: false,
        message: "Chave an√¥nima do Supabase n√£o definida",
        details: { url: true, key: false },
      }
    }

    // Testar a conex√£o
    const { data, error } = await supabase.from("produtos_corretores").select("id").limit(1)

    if (error) {
      console.error("‚ùå Erro ao verificar chaves de API:", error)
      return {
        success: false,
        message: error.message,
        details: { url: true, key: false, error },
      }
    }

    console.log("‚úÖ Chaves de API verificadas com sucesso")
    return {
      success: true,
      message: "Chaves de API v√°lidas",
      details: { url: true, key: true },
    }
  } catch (error) {
    console.error("‚ùå Erro inesperado ao verificar chaves de API:", error)
    return {
      success: false,
      message: error.message,
      details: { error },
    }
  }
}

// Fun√ß√£o para obter as vari√°veis de ambiente do Supabase
export function getSupabaseEnv() {
  return {
    url: supabaseUrl,
    key: supabaseAnonKey,
    isUsingDefaults: !process.env.NEXT_PUBLIC_SUPABASE_URL,
  }
}

// Exportar outras fun√ß√µes necess√°rias
export async function getFieldMapping() {
  return null
}

export async function uploadFile(file: File, bucket = "documentos_propostas", path: string) {
  try {
    console.log(`üì§ UPLOAD SIMPLES - Arquivo: ${file.name}`)
    console.log(`üìÅ Bucket: ${bucket}`)
    console.log(`üìç Path: ${path}`)

    // Validar arquivo
    if (!file) {
      throw new Error("Arquivo n√£o fornecido")
    }

    // Validar tamanho (m√°ximo 5MB)
    const maxSize = 5 * 1024 * 1024 // 5MB em bytes
    if (file.size > maxSize) {
      throw new Error("O arquivo excede o tamanho m√°ximo permitido de 5MB")
    }

    // Validar tipo do arquivo
    const allowedTypes = ["application/pdf", "image/jpeg", "image/png", "image/jpg"]
    if (!allowedTypes.includes(file.type)) {
      throw new Error("Tipo de arquivo n√£o permitido. Use PDF, JPEG ou PNG")
    }

    // Upload direto
    const { data, error } = await supabase.storage.from(bucket).upload(path, file, {
      cacheControl: "3600",
      upsert: true,
    })

    if (error) {
      console.error("‚ùå Erro no upload:", error)
      throw error
    }

    if (!data?.path) {
      throw new Error("Upload falhou: nenhum path retornado")
    }

    // Obter URL p√∫blica
    const { data: publicUrl } = supabase.storage.from(bucket).getPublicUrl(data.path)

    if (!publicUrl?.publicUrl) {
      throw new Error("N√£o foi poss√≠vel obter a URL p√∫blica do arquivo")
    }

    console.log(`‚úÖ Upload conclu√≠do: ${publicUrl.publicUrl}`)
    return publicUrl.publicUrl
  } catch (error) {
    console.error("‚ùå Erro no upload:", error)
    throw error
  }
}

// Outras fun√ß√µes do arquivo...
export async function saveProposta(propostaData: any) {
  try {
    const { data: proposta, error: propostaError } = await supabase
      .from("propostas")
      .insert([propostaData])
      .select()
      .single()

    if (propostaError) {
      console.error("Erro ao salvar proposta:", propostaError)
      throw new Error("Erro ao salvar proposta: " + propostaError.message)
    }

    if (!proposta) {
      throw new Error("Proposta n√£o foi salva corretamente")
    }

    return proposta
  } catch (error) {
    console.error("Erro ao salvar proposta:", error)
    throw error
  }
}

export async function saveDependente(dependenteData: any) {
  try {
    const { data: dependente, error: dependenteError } = await supabase
      .from("dependentes")
      .insert([dependenteData])
      .select()
      .single()

    if (dependenteError) {
      console.error("Erro ao salvar dependente:", dependenteError)
      throw new Error("Erro ao salvar dependente: " + dependenteError.message)
    }

    if (!dependente) {
      throw new Error("Dependente n√£o foi salvo corretamente")
    }

    return dependente
  } catch (error) {
    console.error("Erro ao salvar dependente:", error)
    throw error
  }
}

export async function saveDocumento(documentoData: any) {
  try {
    const { data: documento, error: documentoError } = await supabase
      .from("documentos")
      .insert([documentoData])
      .select()
      .single()

    if (documentoError) {
      console.error("Erro ao salvar documento:", documentoError)
      throw new Error("Erro ao salvar documento: " + documentoError.message)
    }

    if (!documento) {
      throw new Error("Documento n√£o foi salvo corretamente")
    }

    return documento
  } catch (error) {
    console.error("Erro ao salvar documento:", error)
    throw error
  }
}

export async function saveQuestionario(questionarioData: any) {
  try {
    const { data: questionario, error: questionarioError } = await supabase
      .from("questionario_saude")
      .insert([questionarioData])
      .select()
      .single()

    if (questionarioError) {
      console.error("Erro ao salvar question√°rio:", questionarioError)
      throw new Error("Erro ao salvar question√°rio: " + questionarioError.message)
    }

    if (!questionario) {
      throw new Error("Question√°rio n√£o foi salvo corretamente")
    }

    return questionario
  } catch (error) {
    console.error("Erro ao salvar question√°rio:", error)
    throw error
  }
}

export async function getPropostas() {
  const { data: propostas, error } = await supabase
    .from("propostas")
    .select(`
     *,
     documentos (
       tipo,
       arquivo_url,
       arquivo_nome
     ),
     dependentes (
       *
     ),
     questionario_saude (
       *
     )
   `)
    .order("created_at", { ascending: false })

  if (error) {
    console.error("Erro ao buscar propostas:", error)
    throw error
  }

  return propostas
}

export async function downloadFile(url: string, fileName: string) {
  try {
    const response = await fetch(url)
    const blob = await response.blob()
    const downloadUrl = window.URL.createObjectURL(blob)
    const link = document.createElement("a")
    link.href = downloadUrl
    link.download = fileName
    document.body.appendChild(link)
    link.click()
    link.remove()
    window.URL.revokeObjectURL(downloadUrl)
  } catch (error) {
    console.error("Erro ao fazer download:", error)
    throw error
  }
}

export async function exportToExcel(propostas: any[]) {
  try {
    // Preparar os dados para o Excel
    const data = propostas.map((proposta) => {
      const dependentes = proposta.dependentes?.map((dep: any) => `${dep.nome} (${dep.parentesco})`).join(", ") || ""

      const documentos = proposta.documentos?.map((doc: any) => doc.tipo).join(", ") || ""

      return {
        Nome: proposta.nome,
        CPF: proposta.cpf,
        Email: proposta.email,
        Telefone: proposta.telefone,
        Endere√ßo: proposta.endereco,
        "Data de Nascimento": proposta.data_nascimento,
        Dependentes: dependentes,
        Documentos: documentos,
        "Data de Cria√ß√£o": new Date(proposta.created_at).toLocaleDateString(),
      }
    })

    // Criar planilha
    const ws = XLSX.utils.json_to_sheet(data)
    const wb = XLSX.utils.book_new()
    XLSX.utils.book_append_sheet(wb, ws, "Propostas")

    // Gerar arquivo
    XLSX.writeFile(wb, "propostas.xlsx")
  } catch (error) {
    console.error("Erro ao exportar para Excel:", error)
    throw error
  }
}

// Teste de conex√£o autom√°tico quando o m√≥dulo √© carregado
if (typeof window !== "undefined") {
  testarConexao().then((result) => {
    if (result.success) {
      console.log("üéâ Sistema pronto para uso!")
    } else {
      console.warn("‚ö†Ô∏è Problemas de conex√£o detectados. Verifique a configura√ß√£o.")
    }
  })
}
